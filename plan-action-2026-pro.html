<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Plan d'Action 2026 - R√©alisation et Constance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1e3a5f',
            secondary: '#2d5a87',
            accent: '#f4a261',
            success: '#2a9d8f',
            warning: '#e9c46a',
            danger: '#e76f51'
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    * { font-family: 'Poppins', sans-serif; box-sizing: border-box; }
    body { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); min-height: 100vh; }
    .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
    .glass-dark { background: rgba(30,58,95,0.9); backdrop-filter: blur(10px); }
    .card-shadow { box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    .progress-ring { transform: rotate(-90deg); }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .pulse { animation: pulse 2s infinite; }
    .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    input, select, textarea { font-size: 16px !important; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .ai-gradient { background: linear-gradient(90deg, #f4a261, #e76f51, #f4a261); background-size: 200% 100%; animation: gradient 1.5s ease infinite; }
    @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    .notif-badge { position: absolute; top: -4px; right: -4px; background: #e76f51; color: white; border-radius: 50%; min-width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; padding: 0 4px; }
  </style>
</head>
<body class="text-gray-800">
  <div id="root"></div>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ========== CONFIGURATION FIREBASE ==========
    // INSTRUCTIONS: Cr√©ez un projet Firebase gratuit sur https://console.firebase.google.com
    // 1. Cr√©ez un nouveau projet
    // 2. Allez dans "Realtime Database" > Cr√©er une base de donn√©es (mode test)
    // 3. Allez dans Param√®tres du projet > Vos applications > Web
    // 4. Copiez les valeurs ci-dessous
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyC95DA-qs6sgwUoasoFq-U-Z-PHBKHxS58",
      authDomain: "plan-action-2026.firebaseapp.com",
      databaseURL: "https://plan-action-2026-default-rtdb.firebaseio.com",
      projectId: "plan-action-2026",
      storageBucket: "plan-action-2026.firebasestorage.app",
      messagingSenderId: "410100763878",
      appId: "1:410100763878:web:d9cbc0323f86717dc9bf27"
    };

    const DEMO_MODE = FIREBASE_CONFIG.apiKey === "AIzaSyC95DA-qs6sgwUoasoFq-U-Z-PHBKHxS58";

    // ========== IC√îNES ==========
    const Icons = {
      home: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
      users: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
      target: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
      gift: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>,
      settings: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
      admin: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
      plus: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
      check: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      x: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      edit: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
      trash: <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
      fire: <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.66 11.2C17.43 10.9 17.15 10.64 16.89 10.38C16.22 9.78 15.46 9.35 14.82 8.72C13.33 7.26 13 4.85 13.95 3C13 3.23 12.17 3.75 11.46 4.32C8.87 6.4 7.85 10.07 9.07 13.22C9.11 13.32 9.15 13.42 9.15 13.55C9.15 13.77 9 13.97 8.8 14.05C8.57 14.15 8.33 14.09 8.14 13.93C8.08 13.88 8.04 13.83 8 13.76C6.87 12.33 6.69 10.28 7.45 8.64C5.78 10 4.87 12.3 5 14.47C5.06 14.97 5.12 15.47 5.29 15.97C5.43 16.57 5.7 17.17 6 17.7C7.08 19.43 8.95 20.67 10.96 20.92C13.1 21.19 15.39 20.8 17.03 19.32C18.86 17.66 19.5 15 18.56 12.72L18.43 12.46C18.22 12 17.66 11.2 17.66 11.2Z"/></svg>,
      download: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
      ai: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>,
      logout: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
      eye: <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
      bell: <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
      book: <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
      heart: <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>,
      brain: <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>,
      wallet: <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>,
      custom: <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>,
    };

    // ========== UTILITAIRES ==========
    const genId = () => Math.random().toString(36).substr(2, 9);
    const fmtDate = (d) => new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
    const fmtNum = (n) => new Intl.NumberFormat('fr-FR').format(n);
    const hashPwd = (p) => btoa(p + '_pa2026');

    // ========== DONN√âES PAR D√âFAUT ==========
    const defDomains = [
      { id: 'spiritual', name: 'Spirituel', icon: 'book', color: '#6366f1' },
      { id: 'physical', name: 'Physique', icon: 'heart', color: '#ef4444' },
      { id: 'intellectual', name: 'Intellectuel', icon: 'brain', color: '#f59e0b' },
      { id: 'financial', name: 'Financier & Projet', icon: 'wallet', color: '#10b981' },
      { id: 'custom', name: 'Personnalis√©', icon: 'custom', color: '#8b5cf6' },
    ];

    const defGoals = [
      { id: 'g1', domainId: 'spiritual', title: 'Lecture Ancien Testament (NIV)', description: '3 lectures minimum par semaine', target: 156, unit: 'chapitres', frequency: 'weekly' },
      { id: 'g2', domainId: 'physical', title: 'Journ√©es de d√©tox', description: '2 jours par mois', target: 24, unit: 'jours', frequency: 'monthly' },
      { id: 'g3', domainId: 'intellectual', title: 'Anglais niveau interm√©diaire', description: 'Via Duolingo et Praktika', target: 365, unit: 'jours', frequency: 'daily' },
      { id: 'g4', domainId: 'intellectual', title: 'Chinois HSK 1-4', description: 'Via HelloChinese', target: 4, unit: 'niveaux', frequency: 'quarterly' },
      { id: 'g5', domainId: 'intellectual', title: 'Publications scientifiques', description: '3 papers ranking A', target: 3, unit: 'papers', frequency: 'semester' },
      { id: 'g6', domainId: 'financial', title: '√âpargne annuelle', description: '2 000 000 XAF', target: 2000000, unit: 'XAF', frequency: 'monthly' },
      { id: 'g7', domainId: 'financial', title: 'Projet Aquacam', description: 'Visibilit√© Cameroun & Chine', target: 100, unit: '%', frequency: 'quarterly' },
    ];

    const defCelebrations = [
      { id: 'c1', title: 'Fin Trimestre 1', date: '2026-03-31', reward: 'D√Æner sp√©cial', message: 'Bravo !', completed: false },
      { id: 'c2', title: 'Fin Trimestre 2', date: '2026-06-30', reward: 'Weekend d√©tente', message: 'Mi-parcours !', completed: false },
      { id: 'c3', title: 'Fin Trimestre 3', date: '2026-09-30', reward: 'Cadeau personnel', message: 'Bient√¥t fini !', completed: false },
      { id: 'c4', title: 'Fin Ann√©e 2026', date: '2026-12-31', reward: 'Grande c√©l√©bration', message: 'Mission accomplie !', completed: false },
    ];

    // Admin Fabien
    const adminFabien = {
      id: 'admin_fabien', username: 'Fabien', password: hashPwd('fabien'), role: 'admin',
      vision: 'Administrateur - Plan d\'Action 2026', createdAt: new Date().toISOString(), approved: true,
      domains: defDomains, goals: defGoals, entries: [], celebrations: defCelebrations,
      notifications: { enabled: true, daily: true, weekly: true, achievements: true }
    };

    // ========== SERVICE DE DONN√âES ==========
    class DataSvc {
      constructor() {
        this.db = null;
        this.listeners = [];
        this.data = this.loadLocal();
        if (!DEMO_MODE) {
          try {
            firebase.initializeApp(FIREBASE_CONFIG);
            this.db = firebase.database();
            this.initFB();
          } catch(e) { console.log('Firebase error'); }
        }
      }
      loadLocal() {
        try {
          const d = localStorage.getItem('pa2026');
          if (d) return JSON.parse(d);
        } catch {}
        return { users: { [adminFabien.id]: adminFabien }, pending: {} };
      }
      saveLocal() { try { localStorage.setItem('pa2026', JSON.stringify(this.data)); } catch {} }
      notify() { this.listeners.forEach(l => l(this.data)); }
      subscribe(cb) { this.listeners.push(cb); return () => { this.listeners = this.listeners.filter(l => l !== cb); }; }
      async initFB() {
        if (!this.db) return;
        this.db.ref('users').on('value', s => { this.data.users = { ...this.data.users, ...(s.val() || {}) }; this.notify(); });
        this.db.ref('pending').on('value', s => { this.data.pending = s.val() || {}; this.notify(); });
        const snap = await this.db.ref('users/admin_fabien').get();
        if (!snap.exists()) await this.db.ref('users/admin_fabien').set(adminFabien);
      }
      async saveUser(u) {
        this.data.users[u.id] = u;
        this.saveLocal();
        if (this.db) await this.db.ref(`users/${u.id}`).set(u);
        this.notify();
      }
      async delUser(id) {
        delete this.data.users[id];
        this.saveLocal();
        if (this.db) await this.db.ref(`users/${id}`).remove();
        this.notify();
      }
      async addPending(u) {
        this.data.pending[u.id] = u;
        this.saveLocal();
        if (this.db) await this.db.ref(`pending/${u.id}`).set(u);
        this.notify();
      }
      async approve(id) {
        const u = this.data.pending[id];
        if (!u) return;
        u.approved = true;
        delete this.data.pending[id];
        this.data.users[id] = u;
        this.saveLocal();
        if (this.db) {
          await this.db.ref(`pending/${id}`).remove();
          await this.db.ref(`users/${id}`).set(u);
        }
        this.notify();
      }
      async reject(id) {
        delete this.data.pending[id];
        this.saveLocal();
        if (this.db) await this.db.ref(`pending/${id}`).remove();
        this.notify();
      }
      login(usr, pwd) {
        const h = hashPwd(pwd);
        for (const u of Object.values(this.data.users)) {
          if (u.username.toLowerCase() === usr.toLowerCase() && u.password === h) {
            if (!u.approved) return { error: 'Compte en attente d\'approbation' };
            return { user: u };
          }
        }
        return { error: 'Identifiants incorrects' };
      }
    }
    const dataSvc = new DataSvc();

    // ========== IA SERVICE ==========
    const aiGenPlan = async (vision, obj) => {
      try {
        const res = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514", max_tokens: 1500,
            messages: [{ role: "user", content: `Tu es un coach. Analyse cette vision: "${vision}" et objectifs: "${obj}". G√©n√®re un JSON avec: domains (id,name,icon[book/heart/brain/wallet/custom],color), goals (id,domainId,title,description,target,unit,frequency), celebrations (id,title,date,reward,message), advice. R√©ponds UNIQUEMENT en JSON valide sans backticks.` }]
          })
        });
        const d = await res.json();
        return JSON.parse((d.content?.[0]?.text || '{}').replace(/```json|```/g, '').trim());
      } catch {
        const goals = [];
        const w = obj.toLowerCase();
        if (w.includes('sport') || w.includes('sant√©')) goals.push({ id: genId(), domainId: 'physical', title: 'Activit√© physique', description: 'R√©guli√®re', target: 150, unit: 's√©ances', frequency: 'weekly' });
        if (w.includes('lire') || w.includes('apprendre')) goals.push({ id: genId(), domainId: 'intellectual', title: 'Apprentissage', description: 'Continu', target: 50, unit: 'sessions', frequency: 'monthly' });
        if (w.includes('argent') || w.includes('√©pargn')) goals.push({ id: genId(), domainId: 'financial', title: '√âpargne', description: 'R√©guli√®re', target: 1000000, unit: 'XAF', frequency: 'monthly' });
        if (goals.length === 0) goals.push({ id: genId(), domainId: 'custom', title: 'Mon objectif', description: vision.substring(0, 50), target: 100, unit: '%', frequency: 'monthly' });
        return { domains: defDomains, goals, celebrations: defCelebrations, advice: 'La constance est la cl√© !' };
      }
    };

    // ========== COMPOSANTS UI ==========
    const ProgressRing = ({ progress, size = 100, stroke = 8, color = '#f4a261' }) => {
      const r = (size - stroke) / 2, c = r * 2 * Math.PI, o = c - (Math.min(progress, 100) / 100) * c;
      return (
        <svg width={size} height={size} className="progress-ring">
          <circle stroke="#e5e7eb" strokeWidth={stroke} fill="transparent" r={r} cx={size/2} cy={size/2} />
          <circle stroke={color} strokeWidth={stroke} strokeLinecap="round" fill="transparent" r={r} cx={size/2} cy={size/2} strokeDasharray={c} strokeDashoffset={o} style={{ transition: 'stroke-dashoffset 0.5s' }} />
        </svg>
      );
    };

    const Modal = ({ open, onClose, title, children, lg }) => {
      if (!open) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={onClose}>
          <div className={`glass rounded-2xl w-full ${lg ? 'max-w-2xl' : 'max-w-lg'} max-h-[90vh] overflow-y-auto card-shadow fade-in`} onClick={e => e.stopPropagation()}>
            <div className="flex items-center justify-between p-4 border-b sticky top-0 glass z-10">
              <h3 className="text-lg font-semibold text-primary">{title}</h3>
              <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded-full">{Icons.x}</button>
            </div>
            <div className="p-4">{children}</div>
          </div>
        </div>
      );
    };

    const DIcon = ({ icon, sz = 'w-7 h-7' }) => {
      const m = { book: Icons.book, heart: Icons.heart, brain: Icons.brain, wallet: Icons.wallet, custom: Icons.custom };
      return <span className={sz}>{m[icon] || Icons.custom}</span>;
    };

    const Toast = ({ msg, type = 'success', onClose }) => {
      useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, []);
      const c = { success: 'bg-success', error: 'bg-danger', warning: 'bg-warning', info: 'bg-primary' };
      return <div className={`fixed top-4 right-4 z-50 ${c[type]} text-white px-4 py-3 rounded-lg shadow-lg fade-in flex items-center gap-2`}>{Icons.check}<span>{msg}</span></div>;
    };

    // ========== LOGIN ==========
    const LoginPage = ({ onLogin }) => {
      const [mode, setMode] = useState('login');
      const [usr, setUsr] = useState('');
      const [pwd, setPwd] = useState('');
      const [vision, setVision] = useState('');
      const [obj, setObj] = useState('');
      const [loading, setLoading] = useState(false);
      const [err, setErr] = useState('');
      const [plan, setPlan] = useState(null);

      const doLogin = e => {
        e.preventDefault();
        setLoading(true); setErr('');
        const r = dataSvc.login(usr, pwd);
        if (r.error) setErr(r.error);
        else onLogin(r.user);
        setLoading(false);
      };

      const doAI = async () => {
        if (!vision.trim()) return;
        setLoading(true); setErr('');
        const p = await aiGenPlan(vision, obj);
        setPlan(p);
        setLoading(false);
      };

      const doRegister = async e => {
        e.preventDefault();
        if (!usr.trim() || !pwd.trim()) return setErr('Remplissez les champs');
        setLoading(true);
        const u = {
          id: 'user_' + genId(), username: usr.trim(), password: hashPwd(pwd), role: 'user',
          vision, objectives: obj, createdAt: new Date().toISOString(), approved: false,
          domains: plan?.domains || defDomains, goals: plan?.goals || [], entries: [], celebrations: plan?.celebrations || defCelebrations,
          notifications: { enabled: true, daily: true, weekly: true, achievements: true }
        };
        await dataSvc.addPending(u);
        setLoading(false);
        alert('Inscription envoy√©e ! En attente d\'approbation.');
        setMode('login');
      };

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="glass rounded-2xl p-6 w-full max-w-md card-shadow fade-in">
            <div className="text-center mb-6">
              <h1 className="text-2xl font-bold text-primary">Plan d'Action 2026</h1>
              <p className="text-sm text-gray-500 italic">¬´ R√©alisation et Constance ¬ª</p>
            </div>

            {DEMO_MODE && (
              <div className="bg-warning/20 border border-warning rounded-lg p-3 mb-4 text-sm">
                <strong>Mode D√©mo</strong> - Configurez Firebase pour le partage<br />
                Admin: <strong>Fabien</strong> / <strong>fabien</strong>
              </div>
            )}

            {err && <div className="bg-danger/20 text-danger rounded-lg p-3 mb-4 text-sm">{err}</div>}

            {mode === 'login' ? (
              <form onSubmit={doLogin} className="space-y-4">
                <input type="text" value={usr} onChange={e => setUsr(e.target.value)} className="w-full p-3 border rounded-lg" placeholder="Nom d'utilisateur" />
                <input type="password" value={pwd} onChange={e => setPwd(e.target.value)} className="w-full p-3 border rounded-lg" placeholder="Mot de passe" />
                <button type="submit" disabled={loading} className="w-full py-3 bg-primary text-white rounded-lg font-medium disabled:opacity-50">
                  {loading ? 'Connexion...' : 'Se connecter'}
                </button>
                <p className="text-center text-sm text-gray-500">
                  Pas de compte ? <button type="button" onClick={() => setMode('register')} className="text-accent font-medium">S'inscrire</button>
                </p>
              </form>
            ) : (
              <div className="space-y-4">
                <input type="text" value={usr} onChange={e => setUsr(e.target.value)} className="w-full p-3 border rounded-lg" placeholder="Nom d'utilisateur *" />
                <input type="password" value={pwd} onChange={e => setPwd(e.target.value)} className="w-full p-3 border rounded-lg" placeholder="Mot de passe *" />
                <textarea value={vision} onChange={e => setVision(e.target.value)} className="w-full p-3 border rounded-lg" rows="2" placeholder="Votre vision 2026..." />
                <textarea value={obj} onChange={e => setObj(e.target.value)} className="w-full p-3 border rounded-lg" rows="2" placeholder="Vos objectifs (sport, finances, apprentissage...)" />
                
                {plan && (
                  <div className="bg-success/10 border border-success rounded-lg p-3 text-sm">
                    ‚ú® <strong>{plan.goals?.length || 0} objectifs</strong> g√©n√©r√©s par l'IA
                    <p className="text-xs text-gray-500 mt-1 italic">{plan.advice}</p>
                  </div>
                )}

                <button type="button" onClick={doAI} disabled={loading || !vision.trim()}
                  className="w-full py-2 bg-accent/20 text-accent rounded-lg font-medium flex items-center justify-center gap-2 disabled:opacity-50">
                  {loading ? 'G√©n√©ration...' : <>{Icons.ai} G√©n√©rer avec l'IA</>}
                </button>
                <button type="button" onClick={doRegister} disabled={loading} className="w-full py-3 bg-primary text-white rounded-lg font-medium disabled:opacity-50">
                  S'inscrire
                </button>
                <p className="text-center text-sm text-gray-500">
                  D√©j√† inscrit ? <button type="button" onClick={() => setMode('login')} className="text-accent font-medium">Se connecter</button>
                </p>
              </div>
            )}
          </div>
        </div>
      );
    };

    // ========== DASHBOARD ==========
    const Dashboard = ({ user, allUsers }) => {
      const { goals = [], entries = [], domains = defDomains } = user;
      const prog = goals.length ? Math.round(goals.reduce((a, g) => a + Math.min((entries.filter(e => e.goalId === g.id).reduce((s, e) => s + (e.value || 0), 0) / g.target) * 100, 100), 0) / goals.length) : 0;
      const domProg = domains.map(d => {
        const dg = goals.filter(g => g.domainId === d.id);
        if (!dg.length) return { ...d, progress: 0 };
        return { ...d, progress: Math.round(dg.reduce((a, g) => a + Math.min((entries.filter(e => e.goalId === g.id).reduce((s, e) => s + (e.value || 0), 0) / g.target) * 100, 100), 0) / dg.length) };
      });
      const streak = (() => {
        let c = 0, d = new Date();
        const today = d.toISOString().split('T')[0];
        while (c < 365) {
          const ds = d.toISOString().split('T')[0];
          if (!entries.some(e => e.date === ds) && ds !== today) break;
          if (entries.some(e => e.date === ds)) c++;
          d.setDate(d.getDate() - 1);
        }
        return c;
      })();

      const ranking = Object.values(allUsers).filter(u => u.approved).map(u => ({
        ...u, prog: u.goals?.length ? Math.round(u.goals.reduce((a, g) => a + Math.min(((u.entries || []).filter(e => e.goalId === g.id).reduce((s, e) => s + (e.value || 0), 0) / g.target) * 100, 100), 0) / u.goals.length) : 0
      })).sort((a, b) => b.prog - a.prog);

      return (
        <div className="fade-in space-y-6 pb-6">
          <div className="text-center text-white py-4">
            <h1 className="text-2xl font-bold">Bonjour, {user.username} üëã</h1>
            <p className="text-white/80 text-sm italic">¬´ R√©alisation et Constance ¬ª</p>
          </div>

          <div className="glass rounded-2xl p-6 card-shadow mx-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-gray-500 text-sm">Progression Globale</p>
                <p className="text-4xl font-bold text-primary">{prog}%</p>
                <div className="flex items-center gap-2 mt-2">
                  <span className="text-accent">{Icons.fire}</span>
                  <span className="text-sm text-gray-600">{streak} jours</span>
                </div>
              </div>
              <div className="relative">
                <ProgressRing progress={prog} />
                <div className="absolute inset-0 flex items-center justify-center">
                  <span className="text-xl font-bold text-primary">{prog}%</span>
                </div>
              </div>
            </div>
          </div>

          <div className="px-4">
            <h3 className="text-white font-semibold mb-3">Par domaine</h3>
            <div className="grid grid-cols-2 gap-3">
              {domProg.map(d => (
                <div key={d.id} className="glass rounded-xl p-3 card-shadow">
                  <div className="flex items-center gap-2 mb-2">
                    <span style={{ color: d.color }}><DIcon icon={d.icon} sz="w-5 h-5" /></span>
                    <span className="font-medium text-sm truncate">{d.name}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2 mb-1">
                    <div className="h-2 rounded-full" style={{ width: `${d.progress}%`, backgroundColor: d.color }}></div>
                  </div>
                  <span className="text-xs text-gray-500">{d.progress}%</span>
                </div>
              ))}
            </div>
          </div>

          {ranking.length > 1 && (
            <div className="px-4">
              <h3 className="text-white font-semibold mb-3">üèÜ Classement</h3>
              <div className="glass rounded-xl p-4 card-shadow">
                {ranking.slice(0, 5).map((u, i) => (
                  <div key={u.id} className={`flex items-center justify-between py-2 ${i > 0 ? 'border-t' : ''}`}>
                    <div className="flex items-center gap-3">
                      <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${i === 0 ? 'bg-yellow-400' : i === 1 ? 'bg-gray-300' : i === 2 ? 'bg-orange-400' : 'bg-gray-100'}`}>{i + 1}</span>
                      <span className={`font-medium ${u.id === user.id ? 'text-accent' : ''}`}>{u.username} {u.id === user.id && '(vous)'}</span>
                    </div>
                    <span className="text-sm font-bold text-primary">{u.prog}%</span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    // ========== COMMUNAUT√â ==========
    const Community = ({ user, allUsers }) => {
      const [sel, setSel] = useState(null);
      const users = Object.values(allUsers).filter(u => u.approved && u.id !== user.id).map(u => ({
        ...u, prog: u.goals?.length ? Math.round(u.goals.reduce((a, g) => a + Math.min(((u.entries || []).filter(e => e.goalId === g.id).reduce((s, e) => s + (e.value || 0), 0) / g.target) * 100, 100), 0) / u.goals.length) : 0
      })).sort((a, b) => b.prog - a.prog);

      return (
        <div className="fade-in pb-20 px-4 py-4">
          <h2 className="text-xl font-bold text-white mb-4">Communaut√©</h2>
          <div className="space-y-3">
            {users.length === 0 ? (
              <div className="glass rounded-xl p-8 text-center card-shadow">
                <span className="text-4xl">üë•</span>
                <p className="text-gray-500 mt-2">Aucun autre utilisateur</p>
              </div>
            ) : users.map(u => (
              <div key={u.id} className="glass rounded-xl p-4 card-shadow" onClick={() => setSel(u)}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold text-lg">
                      {u.username.charAt(0).toUpperCase()}
                    </div>
                    <div>
                      <p className="font-semibold">{u.username}</p>
                      <p className="text-xs text-gray-500">{u.goals?.length || 0} objectifs</p>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className="text-2xl font-bold text-primary">{u.prog}%</p>
                    <span className="text-xs text-accent">{Icons.eye} Voir</span>
                  </div>
                </div>
              </div>
            ))}
          </div>

          <Modal open={!!sel} onClose={() => setSel(null)} title={`${sel?.username}`} lg>
            {sel && (
              <div className="space-y-4">
                {sel.vision && <div className="bg-primary/5 rounded-lg p-3"><p className="text-xs text-gray-500">Vision</p><p className="text-sm">{sel.vision}</p></div>}
                <div className="text-center py-4">
                  <div className="relative inline-block">
                    <ProgressRing progress={sel.prog} size={120} />
                    <div className="absolute inset-0 flex items-center justify-center"><span className="text-2xl font-bold text-primary">{sel.prog}%</span></div>
                  </div>
                </div>
                <h4 className="font-semibold">Objectifs</h4>
                {sel.goals?.map(g => {
                  const c = (sel.entries || []).filter(e => e.goalId === g.id).reduce((s, e) => s + (e.value || 0), 0);
                  const p = Math.min((c / g.target) * 100, 100);
                  const d = (sel.domains || defDomains).find(x => x.id === g.domainId);
                  return (
                    <div key={g.id} className="bg-gray-50 rounded-lg p-3">
                      <div className="flex items-center justify-between mb-1">
                        <span className="text-sm font-medium">{g.title}</span>
                        <span className="text-xs text-gray-500">{Math.round(p)}%</span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-1.5">
                        <div className="h-1.5 rounded-full" style={{ width: `${p}%`, backgroundColor: d?.color || '#6366f1' }}></div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </Modal>
        </div>
      );
    };

    // ========== OBJECTIFS ==========
    const Goals = ({ user, onUpdate }) => {
      const [addG, setAddG] = useState(false);
      const [addE, setAddE] = useState(null);
      const [editG, setEditG] = useState(null);
      const [selDom, setSelDom] = useState('all');
      const domains = user.domains || defDomains;
      const goals = user.goals || [];
      const entries = user.entries || [];
      const filtered = selDom === 'all' ? goals : goals.filter(g => g.domainId === selDom);

      const saveGoal = g => { onUpdate({ ...user, goals: g.id ? goals.map(x => x.id === g.id ? g : x) : [...goals, { ...g, id: genId() }] }); setAddG(false); setEditG(null); };
      const delGoal = id => { if (confirm('Supprimer ?')) onUpdate({ ...user, goals: goals.filter(g => g.id !== id), entries: entries.filter(e => e.goalId !== id) }); };
      const saveEntry = (gid, v, n) => { onUpdate({ ...user, entries: [...entries, { id: genId(), goalId: gid, value: parseFloat(v), note: n, date: new Date().toISOString().split('T')[0], createdAt: new Date().toISOString() }] }); setAddE(null); };

      return (
        <div className="fade-in pb-20 px-4 py-4">
          <h2 className="text-xl font-bold text-white mb-4">Mes Objectifs</h2>
          <div className="flex gap-2 overflow-x-auto pb-2 mb-4 scrollbar-hide">
            <button onClick={() => setSelDom('all')} className={`px-4 py-2 rounded-full text-sm whitespace-nowrap ${selDom === 'all' ? 'bg-accent text-white' : 'glass'}`}>Tous</button>
            {domains.map(d => (
              <button key={d.id} onClick={() => setSelDom(d.id)} className={`px-4 py-2 rounded-full text-sm whitespace-nowrap ${selDom === d.id ? 'text-white' : 'glass'}`} style={selDom === d.id ? { backgroundColor: d.color } : {}}>{d.name}</button>
            ))}
          </div>

          <div className="space-y-3">
            {filtered.map(g => {
              const d = domains.find(x => x.id === g.domainId);
              const c = entries.filter(e => e.goalId === g.id).reduce((s, e) => s + (e.value || 0), 0);
              const p = Math.min((c / g.target) * 100, 100);
              return (
                <div key={g.id} className="glass rounded-xl p-4 card-shadow">
                  <div className="flex items-start justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <span style={{ color: d?.color }}><DIcon icon={d?.icon} sz="w-5 h-5" /></span>
                      <h3 className="font-semibold text-primary">{g.title}</h3>
                    </div>
                    <div className="flex gap-1">
                      <button onClick={() => setEditG(g)} className="p-1 text-gray-400">{Icons.edit}</button>
                      <button onClick={() => delGoal(g.id)} className="p-1 text-gray-400">{Icons.trash}</button>
                    </div>
                  </div>
                  <p className="text-xs text-gray-500 mb-3">{g.description}</p>
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm">{fmtNum(c)} / {fmtNum(g.target)} {g.unit}</span>
                    <span className="text-sm font-medium" style={{ color: d?.color }}>{Math.round(p)}%</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2 mb-3">
                    <div className="h-2 rounded-full" style={{ width: `${p}%`, backgroundColor: d?.color }}></div>
                  </div>
                  <button onClick={() => setAddE(g.id)} className="w-full py-2 bg-primary/10 text-primary rounded-lg text-sm font-medium flex items-center justify-center gap-1">{Icons.plus} Ajouter</button>
                </div>
              );
            })}
          </div>

          <button onClick={() => setAddG(true)} className="fixed bottom-24 right-4 w-14 h-14 bg-accent rounded-full shadow-lg flex items-center justify-center text-white z-40">{Icons.plus}</button>

          <Modal open={addG} onClose={() => setAddG(false)} title="Nouvel objectif">
            <GoalForm domains={domains} onSave={saveGoal} onCancel={() => setAddG(false)} />
          </Modal>
          <Modal open={!!editG} onClose={() => setEditG(null)} title="Modifier">
            {editG && <GoalForm domains={domains} goal={editG} onSave={saveGoal} onCancel={() => setEditG(null)} />}
          </Modal>
          <Modal open={!!addE} onClose={() => setAddE(null)} title="Nouvelle entr√©e">
            <EntryForm goal={goals.find(g => g.id === addE)} onSave={(v, n) => saveEntry(addE, v, n)} onCancel={() => setAddE(null)} />
          </Modal>
        </div>
      );
    };

    const GoalForm = ({ domains, goal, onSave, onCancel }) => {
      const [f, setF] = useState(goal || { domainId: domains[0]?.id, title: '', description: '', target: '', unit: '', frequency: 'weekly' });
      const submit = e => { e.preventDefault(); if (!f.title || !f.target) return alert('Champs requis'); onSave({ ...f, target: parseFloat(f.target) }); };
      return (
        <form onSubmit={submit} className="space-y-4">
          <select value={f.domainId} onChange={e => setF({ ...f, domainId: e.target.value })} className="w-full p-3 border rounded-lg">
            {domains.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
          </select>
          <input type="text" value={f.title} onChange={e => setF({ ...f, title: e.target.value })} className="w-full p-3 border rounded-lg" placeholder="Titre *" />
          <textarea value={f.description} onChange={e => setF({ ...f, description: e.target.value })} className="w-full p-3 border rounded-lg" rows="2" placeholder="Description" />
          <div className="grid grid-cols-2 gap-3">
            <input type="number" value={f.target} onChange={e => setF({ ...f, target: e.target.value })} className="w-full p-3 border rounded-lg" placeholder="Cible *" />
            <input type="text" value={f.unit} onChange={e => setF({ ...f, unit: e.target.value })} className="w-full p-3 border rounded-lg" placeholder="Unit√©" />
          </div>
          <div className="flex gap-3">
            <button type="button" onClick={onCancel} className="flex-1 py-3 border rounded-lg">Annuler</button>
            <button type="submit" className="flex-1 py-3 bg-primary text-white rounded-lg">{goal ? 'Modifier' : 'Cr√©er'}</button>
          </div>
        </form>
      );
    };

    const EntryForm = ({ goal, onSave, onCancel }) => {
      const [v, setV] = useState('');
      const [n, setN] = useState('');
      return (
        <form onSubmit={e => { e.preventDefault(); if (v) onSave(v, n); }} className="space-y-4">
          <p className="text-sm text-gray-500">{goal?.title}</p>
          <input type="number" value={v} onChange={e => setV(e.target.value)} className="w-full p-3 border rounded-lg" placeholder={`Valeur (${goal?.unit || 'unit√©s'})`} autoFocus />
          <textarea value={n} onChange={e => setN(e.target.value)} className="w-full p-3 border rounded-lg" rows="2" placeholder="Note (optionnel)" />
          <div className="flex gap-3">
            <button type="button" onClick={onCancel} className="flex-1 py-3 border rounded-lg">Annuler</button>
            <button type="submit" className="flex-1 py-3 bg-accent text-white rounded-lg">Enregistrer</button>
          </div>
        </form>
      );
    };

    // ========== EXPORT ==========
    const Export = ({ user }) => {
      const [period, setPeriod] = useState('month');
      const [start, setStart] = useState(new Date().toISOString().split('T')[0]);
      const [end, setEnd] = useState(new Date().toISOString().split('T')[0]);
      const [loading, setLoading] = useState(false);

      const genPDF = () => {
        setLoading(true);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const domains = user.domains || defDomains;
        const goals = user.goals || [];
        let entries = user.entries || [];

        if (period === 'custom') {
          entries = entries.filter(e => e.date >= start && e.date <= end);
        } else {
          const now = new Date();
          let s = new Date();
          if (period === 'day') s = now;
          else if (period === 'week') s.setDate(now.getDate() - 7);
          else if (period === 'month') s.setMonth(now.getMonth() - 1);
          else if (period === 'quarter') s.setMonth(now.getMonth() - 3);
          else if (period === 'semester') s.setMonth(now.getMonth() - 6);
          else if (period === 'year') s.setFullYear(now.getFullYear() - 1);
          entries = entries.filter(e => e.date >= s.toISOString().split('T')[0]);
        }

        const prog = goals.length ? Math.round(goals.reduce((a, g) => a + Math.min((entries.filter(e => e.goalId === g.id).reduce((s, e) => s + (e.value || 0), 0) / g.target) * 100, 100), 0) / goals.length) : 0;

        doc.setFontSize(20);
        doc.setTextColor(30, 58, 95);
        doc.text('Plan d\'Action 2026', 105, 20, { align: 'center' });
        doc.setFontSize(12);
        doc.text(`Rapport de ${user.username}`, 105, 28, { align: 'center' });
        doc.setFontSize(10);
        doc.setTextColor(100);
        doc.text(`G√©n√©r√© le ${fmtDate(new Date())}`, 105, 35, { align: 'center' });
        doc.setFontSize(14);
        doc.setTextColor(30, 58, 95);
        doc.text(`Progression: ${prog}%`, 20, 50);

        const data = goals.map(g => {
          const d = domains.find(x => x.id === g.domainId);
          const c = entries.filter(e => e.goalId === g.id).reduce((s, e) => s + (e.value || 0), 0);
          const p = Math.min((c / g.target) * 100, 100);
          return [d?.name || 'N/A', g.title, `${fmtNum(c)} / ${fmtNum(g.target)} ${g.unit}`, `${Math.round(p)}%`];
        });

        doc.autoTable({ startY: 60, head: [['Domaine', 'Objectif', 'Progression', '%']], body: data, theme: 'striped', headStyles: { fillColor: [30, 58, 95] }, styles: { fontSize: 9 } });
        doc.save(`plan-action-2026-${user.username}-${period}.pdf`);
        setLoading(false);
      };

      return (
        <div className="fade-in pb-20 px-4 py-4">
          <h2 className="text-xl font-bold text-white mb-4">Exporter</h2>
          <div className="glass rounded-xl p-4 card-shadow mb-4">
            <h3 className="font-semibold text-primary mb-3">P√©riode</h3>
            <div className="grid grid-cols-3 gap-2 mb-4">
              {[{ k: 'day', l: 'Jour' }, { k: 'week', l: 'Semaine' }, { k: 'month', l: 'Mois' }, { k: 'quarter', l: 'Trimestre' }, { k: 'semester', l: 'Semestre' }, { k: 'year', l: 'Ann√©e' }].map(p => (
                <button key={p.k} onClick={() => setPeriod(p.k)} className={`py-2 rounded-lg text-sm ${period === p.k ? 'bg-accent text-white' : 'bg-gray-100'}`}>{p.l}</button>
              ))}
            </div>
            <button onClick={() => setPeriod('custom')} className={`w-full py-2 rounded-lg text-sm mb-3 ${period === 'custom' ? 'bg-accent text-white' : 'bg-gray-100'}`}>Personnalis√©e</button>
            {period === 'custom' && (
              <div className="grid grid-cols-2 gap-3">
                <div><label className="text-xs text-gray-500">Du</label><input type="date" value={start} onChange={e => setStart(e.target.value)} className="w-full p-2 border rounded-lg text-sm" /></div>
                <div><label className="text-xs text-gray-500">Au</label><input type="date" value={end} onChange={e => setEnd(e.target.value)} className="w-full p-2 border rounded-lg text-sm" /></div>
              </div>
            )}
          </div>
          <button onClick={genPDF} disabled={loading} className="w-full glass rounded-xl p-4 card-shadow flex items-center justify-center gap-3 text-primary font-medium disabled:opacity-50">
            {Icons.download} {loading ? 'G√©n√©ration...' : 'T√©l√©charger PDF'}
          </button>
        </div>
      );
    };

    // ========== ADMIN ==========
    const Admin = ({ user, allUsers, pending }) => {
      const [tab, setTab] = useState('pending');
      const pendingList = Object.values(pending || {});
      const usersList = Object.values(allUsers || {}).filter(u => u.approved);

      return (
        <div className="fade-in pb-20 px-4 py-4">
          <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">{Icons.admin} Admin</h2>
          <div className="flex gap-2 mb-4">
            <button onClick={() => setTab('pending')} className={`flex-1 py-2 rounded-lg text-sm relative ${tab === 'pending' ? 'bg-accent text-white' : 'glass'}`}>
              En attente {pendingList.length > 0 && <span className="notif-badge">{pendingList.length}</span>}
            </button>
            <button onClick={() => setTab('users')} className={`flex-1 py-2 rounded-lg text-sm ${tab === 'users' ? 'bg-accent text-white' : 'glass'}`}>Utilisateurs ({usersList.length})</button>
          </div>

          {tab === 'pending' && (
            <div className="space-y-3">
              {pendingList.length === 0 ? (
                <div className="glass rounded-xl p-8 text-center card-shadow"><span className="text-4xl">‚úÖ</span><p className="text-gray-500 mt-2">Aucune inscription</p></div>
              ) : pendingList.map(u => (
                <div key={u.id} className="glass rounded-xl p-4 card-shadow">
                  <p className="font-semibold text-primary">{u.username}</p>
                  <p className="text-xs text-gray-500 mb-2">Inscrit le {fmtDate(u.createdAt)}</p>
                  {u.vision && <div className="bg-gray-50 rounded-lg p-2 mb-2 text-sm"><strong>Vision:</strong> {u.vision}</div>}
                  {u.objectives && <div className="bg-gray-50 rounded-lg p-2 mb-2 text-sm"><strong>Objectifs:</strong> {u.objectives}</div>}
                  <div className="flex gap-2">
                    <button onClick={() => dataSvc.approve(u.id)} className="flex-1 py-2 bg-success text-white rounded-lg text-sm">{Icons.check} Approuver</button>
                    <button onClick={() => { if (confirm('Rejeter ?')) dataSvc.reject(u.id); }} className="flex-1 py-2 bg-danger text-white rounded-lg text-sm">{Icons.x} Rejeter</button>
                  </div>
                </div>
              ))}
            </div>
          )}

          {tab === 'users' && (
            <div className="space-y-3">
              {usersList.map(u => {
                const p = u.goals?.length ? Math.round(u.goals.reduce((a, g) => a + Math.min(((u.entries || []).filter(e => e.goalId === g.id).reduce((s, e) => s + (e.value || 0), 0) / g.target) * 100, 100), 0) / u.goals.length) : 0;
                return (
                  <div key={u.id} className="glass rounded-xl p-4 card-shadow">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${u.role === 'admin' ? 'bg-accent text-white' : 'bg-primary/20 text-primary'}`}>{u.username.charAt(0).toUpperCase()}</div>
                        <div>
                          <p className="font-semibold flex items-center gap-1">{u.username} {u.role === 'admin' && <span className="text-xs bg-accent text-white px-1.5 py-0.5 rounded">Admin</span>}</p>
                          <p className="text-xs text-gray-500">{u.goals?.length || 0} obj ‚Ä¢ {p}%</p>
                        </div>
                      </div>
                      {u.id !== user.id && u.role !== 'admin' && (
                        <button onClick={() => { if (confirm('Supprimer ?')) dataSvc.delUser(u.id); }} className="p-2 text-danger">{Icons.trash}</button>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    // ========== SETTINGS ==========
    const Settings = ({ user, onUpdate, onLogout }) => {
      const [edit, setEdit] = useState(false);
      const [f, setF] = useState({ username: user.username, email: user.email || '', password: '' });
      const notif = user.notifications || { enabled: true, daily: true, weekly: true, achievements: true };

      const save = () => {
        const u = { ...user, username: f.username, email: f.email };
        if (f.password) u.password = hashPwd(f.password);
        onUpdate(u);
        setEdit(false);
        setF({ ...f, password: '' });
      };

      const toggleNotif = k => onUpdate({ ...user, notifications: { ...notif, [k]: !notif[k] } });

      return (
        <div className="fade-in pb-20 px-4 py-4">
          <h2 className="text-xl font-bold text-white mb-4">Param√®tres</h2>

          <div className="glass rounded-xl p-4 card-shadow mb-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold text-primary">Mon Profil</h3>
              <button onClick={() => setEdit(!edit)} className="text-accent text-sm">{edit ? 'Annuler' : 'Modifier'}</button>
            </div>
            {edit ? (
              <div className="space-y-3">
                <input type="text" value={f.username} onChange={e => setF({ ...f, username: e.target.value })} className="w-full p-2 border rounded-lg" placeholder="Nom" />
                <input type="email" value={f.email} onChange={e => setF({ ...f, email: e.target.value })} className="w-full p-2 border rounded-lg" placeholder="Email" />
                <input type="password" value={f.password} onChange={e => setF({ ...f, password: e.target.value })} className="w-full p-2 border rounded-lg" placeholder="Nouveau mot de passe" />
                <button onClick={save} className="w-full py-2 bg-primary text-white rounded-lg">Enregistrer</button>
              </div>
            ) : (
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 rounded-full bg-primary flex items-center justify-center text-white font-bold text-xl">{user.username.charAt(0).toUpperCase()}</div>
                <div><p className="font-semibold">{user.username}</p><p className="text-xs text-gray-500">{user.role === 'admin' ? 'Administrateur' : 'Utilisateur'}</p></div>
              </div>
            )}
          </div>

          <div className="glass rounded-xl p-4 card-shadow mb-4">
            <h3 className="font-semibold text-primary mb-3 flex items-center gap-2">{Icons.bell} Notifications</h3>
            {[{ k: 'enabled', l: 'Activer' }, { k: 'daily', l: 'Rappel quotidien' }, { k: 'weekly', l: 'R√©sum√© hebdo' }, { k: 'achievements', l: 'C√©l√©brations' }].map(n => (
              <div key={n.k} className="flex items-center justify-between py-2">
                <span className="text-sm">{n.l}</span>
                <button onClick={() => toggleNotif(n.k)} className={`w-12 h-6 rounded-full p-1 transition-colors ${notif[n.k] ? 'bg-success' : 'bg-gray-300'}`}>
                  <div className={`w-4 h-4 rounded-full bg-white transition-transform ${notif[n.k] ? 'translate-x-6' : ''}`}></div>
                </button>
              </div>
            ))}
          </div>

          <button onClick={onLogout} className="w-full glass rounded-xl p-4 card-shadow flex items-center justify-center gap-2 text-danger font-medium">{Icons.logout} D√©connexion</button>

          <div className="glass rounded-xl p-4 card-shadow mt-4 text-center">
            <p className="text-primary font-semibold">Plan d'Action 2026</p>
            <p className="text-xs text-gray-500 italic">¬´ R√©alisation et Constance ¬ª</p>
            <p className="text-xs text-gray-400 mt-2">Version 2.0 Pro</p>
          </div>
        </div>
      );
    };

    // ========== APP ==========
    const App = () => {
      const [user, setUser] = useState(null);
      const [allUsers, setAllUsers] = useState({});
      const [pending, setPending] = useState({});
      const [tab, setTab] = useState('home');
      const [toast, setToast] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const init = async () => {
          setAllUsers(dataSvc.data.users);
          setPending(dataSvc.data.pending);
          const sess = localStorage.getItem('pa2026_sess');
          if (sess && dataSvc.data.users[sess]?.approved) setUser(dataSvc.data.users[sess]);
          setLoading(false);
          dataSvc.subscribe(d => {
            setAllUsers(d.users || {});
            setPending(d.pending || {});
            if (user && d.users[user.id]) setUser(d.users[user.id]);
          });
        };
        init();
      }, []);

      const login = u => { setUser(u); localStorage.setItem('pa2026_sess', u.id); setTab('home'); };
      const logout = () => { setUser(null); localStorage.removeItem('pa2026_sess'); };
      const update = async u => { await dataSvc.saveUser(u); setUser(u); setToast({ msg: 'Sauvegard√© !', type: 'success' }); };

      if (loading) return <div className="min-h-screen flex items-center justify-center"><div className="text-center text-white"><div className="text-4xl mb-4 pulse">‚è≥</div><p>Chargement...</p></div></div>;
      if (!user) return <LoginPage onLogin={login} />;

      const isAdmin = user.role === 'admin';
      const pendingCount = Object.keys(pending).length;
      const tabs = [
        { id: 'home', icon: Icons.home, label: 'Accueil' },
        { id: 'community', icon: Icons.users, label: '√âquipe' },
        { id: 'goals', icon: Icons.target, label: 'Objectifs' },
        { id: 'export', icon: Icons.download, label: 'Export' },
        ...(isAdmin ? [{ id: 'admin', icon: Icons.admin, label: 'Admin', badge: pendingCount }] : []),
        { id: 'settings', icon: Icons.settings, label: 'Config' },
      ];

      return (
        <div className="min-h-screen pb-20">
          {toast && <Toast {...toast} onClose={() => setToast(null)} />}
          {tab === 'home' && <Dashboard user={user} allUsers={allUsers} />}
          {tab === 'community' && <Community user={user} allUsers={allUsers} />}
          {tab === 'goals' && <Goals user={user} onUpdate={update} />}
          {tab === 'export' && <Export user={user} />}
          {tab === 'admin' && isAdmin && <Admin user={user} allUsers={allUsers} pending={pending} />}
          {tab === 'settings' && <Settings user={user} onUpdate={update} onLogout={logout} />}

          <nav className="fixed bottom-0 left-0 right-0 glass border-t px-1 py-2">
            <div className="flex justify-around items-center max-w-lg mx-auto">
              {tabs.map(t => (
                <button key={t.id} onClick={() => setTab(t.id)} className={`flex flex-col items-center p-2 rounded-xl min-w-[48px] relative ${tab === t.id ? 'text-accent' : 'text-gray-400'}`}>
                  {t.icon}
                  <span className="text-[10px] mt-1">{t.label}</span>
                  {t.badge > 0 && <span className="notif-badge">{t.badge}</span>}
                </button>
              ))}
            </div>
          </nav>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
